<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taskify</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        (function () {
            try {
                const savedPrimaryColor = localStorage.getItem('taskify-primary-color');
                const savedTheme = localStorage.getItem('taskify-theme');
                const docElement = document.documentElement;
                const faviconEl = document.getElementById('favicon');
                let initialFaviconColor = '#007AFF'; // Cor padrão do Bootstrap

                if (savedPrimaryColor) {
                    docElement.style.setProperty('--primary-color-light', savedPrimaryColor);
                    docElement.style.setProperty('--primary-color-dark', savedPrimaryColor);
                    initialFaviconColor = savedPrimaryColor;
                }

                if (faviconEl) {
                    faviconEl.href = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='${encodeURIComponent(initialFaviconColor)}' class='bi bi-check2-square' viewBox='0 0 16 16'><path d='M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8A1.5 1.5 0 0 1 12.5 3v1.5a.5.5 0 0 1-1 0V3a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 1 0 1H3z'/><path d='m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z'/></svg>`;
                }

                if (savedTheme === 'light') {
                    docElement.classList.add('light-theme-active');
                }

            } catch (e) {
                console.warn('Error applying initial theme/color from inline script:', e);
            }
        })();
    </script>

    <link id="favicon" rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23007AFF' class='bi bi-check2-square' viewBox='0 0 16 16'><path d='M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8A1.5 1.5 0 0 1 12.5 3v1.5a.5.5 0 0 1-1 0V3a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 1 0 1H3z'/><path d='m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z'/></svg>"
        type="image/svg+xml">

    <style>
        :root {
            --nav-icon-btn-color-light: #333;
            --nav-icon-btn-color-dark: #fff;
            --primary-color-light: #007AFF;
            --primary-color-dark: #007AFF;
            --counter-btn-base-bg-dark: #282a2e;
            --counter-btn-base-bg-light: #e8eaed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: white;
            min-height: 100vh;
            background: #020306;
            transition: color 0.3s ease;
            /* Para evitar scrollbars indesejadas com as partículas */
        }

        body.light {
            color: #212529;
            background: #f8f9fa;
        }

        body.modal-open {
            overflow: hidden;
        }

        a,
        button,
        input[type="button"],
        input[type="submit"],
        input[type="reset"],
        .btn,
        .counter-btn,
        .logo,
        .theme-toggle-btn,
        .btn-icon-nav,
        .modal-close-btn,
        input[type="color"] {
            cursor: pointer;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            cursor: text;
        }


        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        html.light-theme-active .loader-container,
        body.light .loader-container {
            background: rgba(255, 255, 255, 0.8);
        }


        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            /* Espaço para o header fixo, se houver, ou apenas margem superior */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -4px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            /* Para o posicionamento absoluto do contador */
        }

        body.light .header {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .btn-icon-nav,
        .theme-toggle-btn {
            background: none;
            border: none;
            font-size: 1.6rem;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease;
            line-height: 1;
            color: var(--nav-icon-btn-color-dark);
        }

        body.light .btn-icon-nav,
        body.light .theme-toggle-btn {
            color: var(--nav-icon-btn-color-light);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 26px;
            font-weight: 600;
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-color-dark);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-top: 3px;
            /* Ajuste fino vertical */
        }


        body.light .logo-icon {
            background: var(--primary-color-light);
        }

        /* Input de cor escondido */
        #direct-color-input {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            left: -100px;
            top: -100px;
            pointer-events: none;
        }


        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        body.light .stat-card {
            background: #ffffff;
            border-color: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #343a40;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.15), 0 5px 8px -4px rgba(0, 0, 0, 0.15);
        }

        body.light .stat-card:hover {
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.1), 0 5px 8px -4px rgba(0, 0, 0, 0.1);
        }


        .stat-title {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 16px;
            font-weight: 500;
        }

        body.light .stat-title {
            color: #495057;
            font-weight: 600;
        }

        .circular-progress {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 16px;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
            r: 52;
            /* (120/2) - (8/2) = 60 - 4 = 56, mas a imagem parece ter raio menor */
            cx: 60;
            cy: 60;
            transition: stroke-dashoffset 0.35s, stroke 0.3s ease;
        }

        .progress-ring-bg {
            stroke: rgba(255, 255, 255, 0.15);
        }

        body.light .progress-ring-bg {
            stroke: #e9ecef;
        }

        .progress-ring-fill {
            stroke: var(--primary-color-dark);
            stroke-linecap: round;
        }

        body.light .progress-ring-fill {
            stroke: var(--primary-color-light);
        }

        .progress-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            font-weight: 700;
        }

        body.light .progress-number {
            color: #212529;
            font-weight: 700;
        }

        .progress-target {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        body.light .progress-target {
            color: #6c757d;
        }

        .bottom-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        body.light .info-card {
            background: #ffffff;
            border-color: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #343a40;
        }

        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.15), 0 5px 8px -4px rgba(0, 0, 0, 0.15);
        }

        body.light .info-card:hover {
            box-shadow: 0 12px 20px -3px rgba(0, 0, 0, 0.1), 0 5px 8px -4px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 16px;
            color: #aaa;
            margin-bottom: 12px;
            font-weight: 500;
        }

        body.light .card-title {
            color: #495057;
            font-weight: 600;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        body.light .card-value {
            color: #212529;
            font-weight: 700;
        }

        .card-subtitle {
            font-size: 14px;
            color: #888;
        }

        body.light .card-subtitle {
            color: #6c757d;
        }


        .progress-bar-horizontal {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
            /* Ajustado para dar espaço ao valor do streak */
        }

        body.light .progress-bar-horizontal {
            background: #e0e0e0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color-dark);
            border-radius: 4px;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        body.light .progress-fill {
            background: var(--primary-color-light);
        }


        .activity-section {
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            /* Espaço antes do fim da página */
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -4px rgba(0, 0, 0, 0.1);
            color: white;
        }

        body.light .activity-section {
            background: #ffffff;
            border-color: #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #343a40;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .activity-title {
            font-size: 18px;
            font-weight: 600;
        }

        .activity-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .activity-controls .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ccc;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        body.light .activity-controls .control-btn {
            background: #eee;
            border-color: #ddd;
            color: #555;
        }

        .activity-controls .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        body.light .activity-controls .control-btn:hover {
            background: #ddd;
        }


        .activity-value {
            /* Ex: "Últimos 7 dias" */
            background: var(--primary-color-dark);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        body.light .activity-value {
            background: var(--primary-color-light);
            color: white;
        }


        .chart-container {
            height: 200px;
            /* Altura do gráfico */
            position: relative;
            overflow: hidden;
            /* Para garantir que o gráfico não transborde */
        }

        /* Contador de Questões no Header */
        .question-counter {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .counter-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: color-mix(in srgb, var(--primary-color-dark) 25%, var(--counter-btn-base-bg-dark));
            color: var(--primary-color-dark);
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease, color 0.3s ease, background-color 0.3s ease;
        }

        body.light .counter-btn {
            background: color-mix(in srgb, var(--primary-color-light) 25%, var(--counter-btn-base-bg-light));
            color: var(--primary-color-light);
        }

        .counter-btn:hover {
            background: color-mix(in srgb, var(--primary-color-dark) 40%, var(--counter-btn-base-bg-dark));
            transform: scale(1.05);
        }

        body.light .counter-btn:hover {
            background: color-mix(in srgb, var(--primary-color-light) 40%, var(--counter-btn-base-bg-light));
        }

        .counter-btn:active {
            transform: scale(0.95);
        }

        .counter-display {
            /* Input numérico do step */
            font-size: 24px;
            font-weight: 600;
            min-width: 50px;
            /* Para o número caber bem */
            text-align: center;
            color: var(--primary-color-dark);
            margin: 0 4px;
            /* Espaçamento entre botões e input */
            transition: color 0.3s ease;
        }

        body.light .counter-display {
            color: var(--primary-color-light);
        }

        /* Estilização específica para o input de step para parecer texto */
        #questions-step-input.counter-display {
            border: none;
            background-color: transparent;
            padding: 0;
            max-width: 80px;
            outline: none;
            box-shadow: none;
        }

        #questions-step-input.counter-display::-webkit-outer-spin-button,
        #questions-step-input.counter-display::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #questions-step-input.counter-display {
            /* Firefox */
            -moz-appearance: textfield;
        }


        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.show {
            display: block;
            opacity: 1;
        }

        body.light .modal-overlay {
            background: rgba(255, 255, 255, 0.4);
        }


        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: #121212;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px;
            padding-top: 48px;
            /* Espaço para o botão de fechar */
            width: 90%;
            max-width: 500px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal.show {
            display: block;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        body.light .modal {
            background: #fdfdfd;
            border-color: #ddd;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-color-dark);
            padding: 8px;
            line-height: 1;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
            z-index: 10;
        }

        body.light .modal-close-btn {
            color: var(--primary-color-light);
        }

        .modal-close-btn:hover {
            background-color: rgba(128, 128, 128, 0.15);
            transform: scale(1.1);
        }

        body.light .modal-close-btn:hover {
            background-color: rgba(0, 0, 0, 0.08);
        }

        .modal-close-btn:active {
            transform: scale(0.95);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
            text-align: center;
        }

        body.light .modal-title {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #aaa;
        }

        body.light .form-label {
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #222;
            color: white;
            font-size: 16px;
            -moz-appearance: textfield;
            /* Firefox: remove setas do input number */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-input::-webkit-outer-spin-button,
        /* Chrome, Safari, Edge, Opera: remove setas */
        .form-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color-dark);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color-dark) 30%, transparent);
        }

        body.light .form-input {
            background: #f0f0f0;
            border-color: #ccc;
            color: #333;
        }

        body.light .form-input:focus {
            border-color: var(--primary-color-light);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-color-light) 20%, transparent);
        }


        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease, background-color 0.3s ease, color 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color-dark);
            color: white;
        }

        body.light .btn-primary {
            background: var(--primary-color-light);
        }

        .btn-primary:hover {
            opacity: 0.8;
        }

        .btn-secondary {
            background: #333;
            color: #ccc;
        }

        body.light .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #444;
        }

        body.light .btn-secondary:hover {
            background: #d0d0d0;
        }


        /* Loader Styles */
        .loader {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 3px solid;
            border-color: var(--primary-color-dark) var(--primary-color-dark) transparent transparent;
            animation: rotation 1s linear infinite;
        }

        html.light-theme-active .loader,
        body.light .loader {
            border-color: var(--primary-color-light) var(--primary-color-light) transparent transparent;
        }


        .loader::after,
        .loader::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            margin: auto;
            border-radius: 50%;
        }

        .loader::after {
            width: 40px;
            height: 40px;
            border: 3px solid;
            border-color: transparent transparent var(--primary-color-dark) var(--primary-color-dark);
            animation: rotationBack 0.5s linear infinite;
        }

        html.light-theme-active .loader::after,
        body.light .loader::after {
            border-color: transparent transparent var(--primary-color-light) var(--primary-color-light);
        }


        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes rotationBack {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(-360deg);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .bottom-cards {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                /* Stack elements vertically */
                gap: 20px;
                /* Space between stacked items */
                align-items: stretch;
                /* Make items take full width */
                padding: 16px;
            }

            .header .logo {
                justify-content: center;
                /* Center logo if it takes full width */
            }

            .header .question-counter {
                order: 1;
                /* Move counter below logo */
                position: static;
                /* Reset absolute positioning */
                transform: none;
                /* Reset transform */
            }

            .header .header-controls {
                justify-content: center;
                /* Center controls */
                order: 2;
                /* Move controls to the bottom */
            }

            .main-title {
                /* If you had a main title outside header */
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                /* Single column for very small screens */
            }

            .container {
                padding: 15px;
            }

            .modal {
                padding: 24px;
                padding-top: 40px;
                max-width: 95%;
            }

            .modal-close-btn {
                top: 10px;
                right: 10px;
                font-size: 1.3rem;
            }

            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
        }

        /* Header layout refined for central counter */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            /* For absolute positioning of counter */
        }

        .question-counter {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            /* Reduced gap for tighter look if needed */
        }

        .header-controls {
            margin-left: auto;
            /* Pushes controls to the right, if not centered */
        }

        /* Responsive override for header layout */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap;
                /* Allow items to wrap */
                padding-bottom: 50px;
                /* Extra padding if counter moves below */
            }

            .question-counter {
                position: absolute;
                /* Make it absolute again relative to header */
                bottom: 20px;
                /* Position at the bottom of the header */
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
                /* Make it take full width for centering */
                justify-content: center;
            }

            .logo,
            .header-controls {
                /* Ensure these don't conflict with full-width counter */
                width: auto;
                /* Or specific width if needed */
            }
        }

        #direct-color-input {
            position: absolute;
            right: 100%;
            left: -27%;
            top: 0%;
            transform: translate(-50%, -50%);
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <canvas id="particle-canvas"></canvas>
    <div class="loader-container" id="loader">
        <span class="loader"></span>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo" title="Clique para mudar a cor primária">
                <div class="logo-icon">✓</div>
                Taskify
            </div>
            <input type="color" id="direct-color-input">


            <div class="question-counter">
                <button class="counter-btn" id="decrement-btn" onclick="decrementToday()">−</button>
                <input type="number" class="counter-display" id="questions-step-input" value="1" min="1">
                <button class="counter-btn" id="increment-btn" onclick="incrementToday()">+</button>
            </div>

            <div class="header-controls">
                <button class="btn-icon-nav" id="btn-edit-goals-header" aria-label="Editar metas"
                    onclick="openGoalsModal()">
                    <i class="bi bi-pencil-square"></i>
                </button>
                <button class="theme-toggle-btn" id="theme-toggle" aria-label="Alternar tema" onclick="toggleTheme()">
                    <i id="theme-icon" class="bi bi-moon-fill"></i>
                </button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-title">Hoje</div>
                <div class="circular-progress">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52" stroke-width="8" />
                        <circle class="progress-ring-circle progress-ring-fill" id="today-progress" cx="60" cy="60"
                            r="52" stroke-width="8"
                            style="stroke-dasharray: 326.7256359611859, 326.7256359611859; stroke-dashoffset: 326.7256359611859" />
                    </svg>
                    <div class="progress-number" id="today-count">0</div>
                </div>
                <div class="progress-target">Meta: <span id="today-target">20</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-title">Semana</div>
                <div class="circular-progress">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52" stroke-width="8" />
                        <circle class="progress-ring-circle progress-ring-fill" id="week-progress" cx="60" cy="60"
                            r="52" stroke-width="8"
                            style="stroke-dasharray: 326.7256359611859, 326.7256359611859; stroke-dashoffset: 326.7256359611859" />
                    </svg>
                    <div class="progress-number" id="week-count">0</div>
                </div>
                <div class="progress-target">Meta: <span id="week-target">50</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-title">Mês</div>
                <div class="circular-progress">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52" stroke-width="8" />
                        <circle class="progress-ring-circle progress-ring-fill" id="month-progress" cx="60" cy="60"
                            r="52" stroke-width="8"
                            style="stroke-dasharray: 326.7256359611859, 326.7256359611859; stroke-dashoffset: 326.7256359611859" />
                    </svg>
                    <div class="progress-number" id="month-count">0</div>
                </div>
                <div class="progress-target">Meta: <span id="month-target">1200</span></div>
            </div>

            <div class="stat-card">
                <div class="stat-title">Ano</div>
                <div class="circular-progress">
                    <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-circle progress-ring-bg" cx="60" cy="60" r="52" stroke-width="8" />
                        <circle class="progress-ring-circle progress-ring-fill" id="year-progress" cx="60" cy="60"
                            r="52" stroke-width="8"
                            style="stroke-dasharray: 326.7256359611859, 326.7256359611859; stroke-dashoffset: 326.7256359611859" />
                    </svg>
                    <div class="progress-number" id="year-count">0</div>
                </div>
                <div class="progress-target">Meta: <span id="year-target">20000</span></div>
            </div>
        </div>

        <div class="bottom-cards">
            <div class="info-card">
                <div class="card-title">Recorde Diário</div>
                <div class="card-value" id="daily-record-value">0</div>
                <div class="card-subtitle" id="daily-record-date">-</div>
            </div>

            <div class="info-card">
                <div class="card-title">Streak Atual</div>
                <div class="card-value" id="current-streak-value">0 dias</div>
                <div class="progress-bar-horizontal" style="margin-top: 16px;">
                    <div class="progress-fill" id="streak-progress-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="info-card">
                <div class="card-title">Pico de Atividade Semanal</div>
                <div class="card-value" id="peak-activity-day">-</div>
                <div class="card-subtitle" id="peak-activity-questions">0 questões</div>
            </div>
        </div>

        <div class="activity-section">
            <div class="activity-header">
                <div class="activity-title">Atividade Semanal</div>
                <div class="activity-controls">
                    <span style="font-size:0.9em; color: #888;" id="weekly-activity-period">Últimos 7 dias</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="weeklyActivityChart"></canvas>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="goals-modal-overlay"></div>
    <div class="modal" id="goals-modal">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Fechar" onclick="closeGoalsModal()">
                <i class="bi bi-x-lg"></i>
            </button>
            <h2 class="modal-title">Editar Metas</h2>
            <form id="goals-form">
                <div class="form-group">
                    <label class="form-label" for="daily-goal-input">Meta Diária</label>
                    <input type="number" class="form-input" id="daily-goal-input" value="20" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="weekly-goal-input">Meta Semanal</label>
                    <input type="number" class="form-input" id="weekly-goal-input" value="50" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="monthly-goal-input">Meta Mensal</label>
                    <input type="number" class="form-input" id="monthly-goal-input" value="1200" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="yearly-goal-input">Meta Anual</label>
                    <input type="number" class="form-input" id="yearly-goal-input" value="20000" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label" for="streak-goal-input">Meta de Streak (dias)</label>
                    <input type="number" class="form-input" id="streak-goal-input" value="30" min="1">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeGoalsModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        let weeklyChartInstance = null;

        const initialDefaultState = {
            todayCount: 73,
            lastAccessDate: new Date().toDateString(),
            goals: {
                daily: 100,
                weekly: 600,
                monthly: 2000,
                yearly: 20000,
                streak: 21
            },
            weeklyProgress: 536,
            monthlyProgress: 1804,
            yearlyProgress: 4833,
            weeklyActivityData: [132, 90, 99, 110, 105, 120, 73],
            dailyRecord: {
                value: 143,
                date: "20 de maio"
            },
            currentStreak: {
                days: 0,        // MODIFICADO para corresponder à imagem
                lastCompletionDate: null
            },
            peakActivity: {
                dayName: "Sábado",
                questions: 132
            },
            isDarkMode: true,
            lastWeekStartDate: getStartOfWeek(new Date()).toDateString(),
            lastMonthStartDate: getStartOfMonth(new Date()).toDateString(),
            lastYearStartDate: getStartOfYear(new Date()).toDateString(),
        };

        let state = { ...initialDefaultState };

        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay(); // 0 for Sunday, 1 for Monday, etc.
            // Adjust to make Monday the start of the week (day === 0 ? -6 makes Sunday the last day of prev week)
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getStartOfMonth(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        function getStartOfYear(date) {
            return new Date(date.getFullYear(), 0, 1);
        }

        function getLast7DayLabels() {
            const dayAbbreviations = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
            const labels = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                labels.push(dayAbbreviations[date.getDay()]);
            }
            return labels;
        }


        function populateInitialDataIfEmpty() {
            // Ensure nested objects exist and have defaults if not fully present in loaded state
            state.goals = { ...initialDefaultState.goals, ...(state.goals || {}) };
            state.dailyRecord = { ...initialDefaultState.dailyRecord, ...(state.dailyRecord || {}) };
            state.currentStreak = { ...initialDefaultState.currentStreak, ...(state.currentStreak || {}) };
            state.peakActivity = { ...initialDefaultState.peakActivity, ...(state.peakActivity || {}) };

            // Ensure weeklyActivityData is an array of 7 numbers
            if (!Array.isArray(state.weeklyActivityData) || state.weeklyActivityData.length !== 7) {
                state.weeklyActivityData = [...initialDefaultState.weeklyActivityData];
            } else {
                // Sanitize loaded data to ensure they are numbers
                state.weeklyActivityData = state.weeklyActivityData.map(val => Number(val) || 0);
            }
        }

        function loadState() {
            try {
                const savedStateString = localStorage.getItem('taskify-state');
                if (savedStateString) {
                    const parsedState = JSON.parse(savedStateString);
                    // Merge with initial defaults to ensure all keys are present
                    state = {
                        ...initialDefaultState, // Base defaults
                        ...parsedState,         // Loaded state overrides defaults
                        // Explicitly merge nested objects to ensure their structure
                        goals: { ...initialDefaultState.goals, ...(parsedState.goals || {}) },
                        dailyRecord: { ...initialDefaultState.dailyRecord, ...(parsedState.dailyRecord || {}) },
                        currentStreak: { ...initialDefaultState.currentStreak, ...(parsedState.currentStreak || {}) },
                        peakActivity: { ...initialDefaultState.peakActivity, ...(parsedState.peakActivity || {}) },
                        weeklyActivityData: (parsedState.weeklyActivityData && Array.isArray(parsedState.weeklyActivityData) && parsedState.weeklyActivityData.length === 7)
                            ? parsedState.weeklyActivityData.map(v => Number(v) || 0) // Sanitize
                            : [...initialDefaultState.weeklyActivityData], // Fallback to default if invalid
                    };
                } else {
                    // No saved state, use a deep copy of initial defaults
                    state = JSON.parse(JSON.stringify(initialDefaultState));
                }
            } catch (e) {
                console.error("Error parsing state from localStorage:", e);
                state = JSON.parse(JSON.stringify(initialDefaultState)); // Fallback on error
                localStorage.removeItem('taskify-state'); // Clear corrupted state
            }

            // Load theme preference separately
            const savedTheme = localStorage.getItem('taskify-theme');
            state.isDarkMode = savedTheme !== null ? savedTheme === 'dark' : initialDefaultState.isDarkMode;

            populateInitialDataIfEmpty(); // Final check and sanitization
        }


        function saveState() {
            try {
                localStorage.setItem('taskify-state', JSON.stringify(state));
                localStorage.setItem('taskify-theme', state.isDarkMode ? 'dark' : 'light');
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
            }
        }

        function checkAllResets() {
            const prevLastAccessDate = state.lastAccessDate;
            const prevWeeklyData = [...state.weeklyActivityData]; // Shallow copy for comparison

            checkAndResetDailyCounters();
            checkAndResetWeeklyCounters();
            checkAndResetMonthlyCounters();
            checkAndResetYearlyCounters();

            // Check if weekly data actually changed to avoid unnecessary UI updates
            const weeklyDataChanged = JSON.stringify(prevWeeklyData) !== JSON.stringify(state.weeklyActivityData);

            // Update UI only if necessary
            if (state.lastAccessDate !== prevLastAccessDate || weeklyDataChanged) {
                updateUI(); // This will update the chart data as well
            }
            saveState();
        }

        function checkAndResetDailyCounters() {
            const todayStr = new Date().toDateString();
            if (state.lastAccessDate !== todayStr) {
                state.todayCount = 0;
                state.lastAccessDate = todayStr;

                // Shift weekly activity data: remove oldest, add new day (0 count initially)
                if (state.weeklyActivityData && state.weeklyActivityData.length === 7) {
                    state.weeklyActivityData.shift();
                    state.weeklyActivityData.push(0);
                } else {
                    // Fallback if data is malformed
                    state.weeklyActivityData = [0, 0, 0, 0, 0, 0, 0];
                }
                updatePeakActivity(); // Recalculate peak after data shift
            }
        }

        function checkAndResetWeeklyCounters() {
            const currentWeekStartStr = getStartOfWeek(new Date()).toDateString();
            if (state.lastWeekStartDate !== currentWeekStartStr) {
                state.weeklyProgress = 0;
                state.lastWeekStartDate = currentWeekStartStr;
            }
        }

        function checkAndResetMonthlyCounters() {
            const currentMonthStartStr = getStartOfMonth(new Date()).toDateString();
            if (state.lastMonthStartDate !== currentMonthStartStr) {
                state.monthlyProgress = 0;
                state.lastMonthStartDate = currentMonthStartStr;
            }
        }

        function checkAndResetYearlyCounters() {
            const currentYearStartStr = getStartOfYear(new Date()).toDateString();
            if (state.lastYearStartDate !== currentYearStartStr) {
                state.yearlyProgress = 0;
                state.lastYearStartDate = currentYearStartStr;
            }
        }

        function updateCircularProgress(elementId, current, target) {
            const circle = document.getElementById(elementId);
            if (!circle) return;

            const radius = circle.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;

            // Ensure dasharray is set correctly before calculating offset
            circle.style.strokeDasharray = `${circumference} ${circumference}`;

            // Calculate progress (0 to 1), ensuring target is not zero to avoid division by zero
            const progress = target > 0 ? Math.min(current / target, 1) : 0;
            const dashoffsetValue = circumference * (1 - progress);

            // Apply the new dashoffset
            circle.style.strokeDashoffset = dashoffsetValue;
        }

        function updateUI() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            // Update counts and targets
            setText('today-count', state.todayCount);
            setText('today-target', state.goals.daily);
            updateCircularProgress('today-progress', state.todayCount, state.goals.daily);

            setText('week-count', state.weeklyProgress);
            setText('week-target', state.goals.weekly);
            updateCircularProgress('week-progress', state.weeklyProgress, state.goals.weekly);

            setText('month-count', state.monthlyProgress);
            setText('month-target', state.goals.monthly);
            updateCircularProgress('month-progress', state.monthlyProgress, state.goals.monthly);

            setText('year-count', state.yearlyProgress);
            setText('year-target', state.goals.yearly);
            updateCircularProgress('year-progress', state.yearlyProgress, state.goals.yearly);

            // Update daily record
            setText('daily-record-value', state.dailyRecord.value);
            setText('daily-record-date', state.dailyRecord.date || "-"); // Fallback for date

            // Update streak display
            updateStreakUI();

            // Update peak activity
            setText('peak-activity-day', state.peakActivity.dayName || "-");
            setText('peak-activity-questions', `${state.peakActivity.questions} questões`);

            // Update goal inputs in modal
            document.getElementById('daily-goal-input').value = state.goals.daily;
            document.getElementById('weekly-goal-input').value = state.goals.weekly;
            document.getElementById('monthly-goal-input').value = state.goals.monthly;
            document.getElementById('yearly-goal-input').value = state.goals.yearly;
            document.getElementById('streak-goal-input').value = state.goals.streak;

            // Update page title with today's progress
            document.title = `(${state.goals.daily > 0 ? Math.round((state.todayCount / state.goals.daily) * 100) : 0}%) Taskify®`;
            updateWeeklyChartDataOnly(); // Refresh chart with current data
        }

        function updateDailyRecord() {
            const todayLocaleDate = new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long' });

            if (state.todayCount > state.dailyRecord.value) {
                state.dailyRecord.value = state.todayCount;
                state.dailyRecord.date = todayLocaleDate;
            } else if (state.dailyRecord.date === todayLocaleDate && state.todayCount < state.dailyRecord.value) {
                // If current count for today is less than the record for today (e.g. user decremented)
                // This scenario might not be desired, usually record only goes up or stays.
                // For now, let's assume the record for "today" is just the highest value reached "today".
                state.dailyRecord.value = state.todayCount;
            }
            // If count becomes 0 and record was for today, reset record date or value
            if (state.todayCount === 0 && state.dailyRecord.date === todayLocaleDate) {
                state.dailyRecord.value = 0; // Or find previous record if logic requires
                state.dailyRecord.date = "-";  // Or previous record's date
            }
        }

        function getStepValue() {
            const stepInput = document.getElementById('questions-step-input');
            let step = parseInt(stepInput.value, 10);
            if (isNaN(step) || step < 1) {
                step = 1; // Default to 1 if invalid
                stepInput.value = "1";
            }
            return step;
        }

        function incrementToday() {
            checkAllResets(); // Ensure counters are for the correct periods
            const step = getStepValue();

            state.todayCount += step;
            state.weeklyProgress += step;
            state.monthlyProgress += step;
            state.yearlyProgress += step;

            // Update today's value in weekly activity data (last element)
            if (state.weeklyActivityData && state.weeklyActivityData.length === 7) {
                state.weeklyActivityData[6] += step;
            }

            updateDailyRecord();
            updatePeakActivity(); // Recalculate peak if today's activity changes it
            updateStreak();       // Update streak based on new count and goal

            saveState();
            updateUI();
        }

        function decrementToday() {
            checkAllResets();
            const step = getStepValue();

            // Allow decrementing only if todayCount is positive, or if step is also <=0 (no change)
            if (state.todayCount > 0 || (state.todayCount === 0 && step <= 0)) {
                const newTodayCount = Math.max(0, state.todayCount - step);
                const actualDecrementAmount = state.todayCount - newTodayCount; // How much it actually decreased

                state.todayCount = newTodayCount;
                if (actualDecrementAmount > 0) { // Only update other progresses if there was a change
                    state.weeklyProgress = Math.max(0, state.weeklyProgress - actualDecrementAmount);
                    state.monthlyProgress = Math.max(0, state.monthlyProgress - actualDecrementAmount);
                    state.yearlyProgress = Math.max(0, state.yearlyProgress - actualDecrementAmount);

                    if (state.weeklyActivityData && state.weeklyActivityData.length === 7) {
                        state.weeklyActivityData[6] = Math.max(0, state.weeklyActivityData[6] - actualDecrementAmount);
                    }
                }

                updateDailyRecord();
                updatePeakActivity();
                updateStreak(); // Streak might break or un-break

                saveState();
                updateUI();
            }
        }

        function updatePeakActivity() {
            let maxQuestions = 0;
            let peakDayOriginalIndex = -1; // Index in the weeklyActivityData array

            if (!Array.isArray(state.weeklyActivityData) || state.weeklyActivityData.length !== 7) {
                state.peakActivity = { dayName: "-", questions: 0 }; // Default/reset
                return;
            }

            // Find the max value and its index
            state.weeklyActivityData.forEach((count, index) => {
                if (count >= maxQuestions) { // Use >= to get the latest day in case of a tie
                    maxQuestions = count;
                    peakDayOriginalIndex = index;
                }
            });

            if (peakDayOriginalIndex !== -1 && maxQuestions > 0) {
                const today = new Date();
                const peakDate = new Date(today);
                // Calculate the date of the peak: today - (6 - index_in_array_of_last_7_days)
                peakDate.setDate(today.getDate() - (6 - peakDayOriginalIndex));

                const dayAbbreviations = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                state.peakActivity.dayName = dayAbbreviations[peakDate.getDay()];
                state.peakActivity.questions = maxQuestions;
            } else {
                // No activity or invalid data
                state.peakActivity.dayName = "-";
                state.peakActivity.questions = 0;
            }
        }

        function updateStreak() {
            const todayISO = new Date().toISOString().split('T')[0];
            const dailyGoal = state.goals.daily;
            const todayQuestions = state.todayCount;

            // Load streak data or initialize if not present
            const streakData = JSON.parse(localStorage.getItem('streak')) || {
                current: 0,
                lastValidDate: null,
                history: {} // Store daily counts for met goals: {'YYYY-MM-DD': count}
            };

            const goalMetToday = todayQuestions >= dailyGoal;
            const wasGoalMetForTodayInHistory = streakData.history[todayISO] !== undefined && streakData.history[todayISO] >= dailyGoal;

            if (goalMetToday) {
                // Goal met today
                if (!wasGoalMetForTodayInHistory) {
                    // First time meeting goal today (or count increased to meet goal)
                    addDayToStreak(streakData, todayISO, todayQuestions);
                } else {
                    // Goal already met, just update the count for today in history
                    streakData.history[todayISO] = todayQuestions;
                }
            } else {
                // Goal NOT met today
                if (wasGoalMetForTodayInHistory) {
                    // Goal was previously met today, but now it's not (e.g., user decremented count)
                    removeDayFromStreak(streakData, todayISO);
                }
                // If goal was never met today, do nothing specific here for history
            }

            // Check for broken streak if lastValidDate is not today and not yesterday
            if (streakData.lastValidDate && streakData.lastValidDate !== todayISO) {
                const lastValid = new Date(streakData.lastValidDate);
                const todayDateObj = new Date(todayISO);
                const diffTime = Math.abs(todayDateObj - lastValid);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays > 1) { // More than one day passed since last valid completion
                    streakData.current = goalMetToday ? 1 : 0; // Reset streak
                    if (goalMetToday) {
                        streakData.lastValidDate = todayISO; // Start new streak if goal met today
                    } else {
                        if (streakData.current === 0) streakData.lastValidDate = null; // No streak
                    }
                }
            } else if (!streakData.lastValidDate && goalMetToday) {
                // No previous streak, and goal met today: start a new streak
                streakData.current = 1;
                streakData.lastValidDate = todayISO;
            }


            // Update global state
            state.currentStreak.days = streakData.current;
            state.currentStreak.lastCompletionDate = streakData.lastValidDate;
            saveStreakData(streakData); // Save updated streak data to localStorage
        }


        function addDayToStreak(streakData, dateISO, questions) {
            const yesterday = new Date(dateISO);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayISO = yesterday.toISOString().split('T')[0];

            // If last valid date was already today, it means we're just updating count
            if (streakData.lastValidDate === dateISO) {
                streakData.history[dateISO] = questions;
                return; // current streak count doesn't change
            }

            // If last completion was yesterday, or no streak, or no last valid date
            if (streakData.lastValidDate === yesterdayISO || streakData.current === 0 || streakData.lastValidDate === null) {
                streakData.current += 1;
            } else {
                // Streak was broken, this is a new day 1
                streakData.current = 1;
            }
            streakData.lastValidDate = dateISO;
            streakData.history[dateISO] = questions;
        }

        function removeDayFromStreak(streakData, dateISO) {
            // If the day being removed was the last valid day of the streak
            if (streakData.lastValidDate === dateISO) {
                streakData.current = Math.max(0, streakData.current - 1); // Decrement streak

                if (streakData.current === 0) {
                    streakData.lastValidDate = null; // Streak broken, no last valid date
                } else {
                    // Find the new last valid date from history (day before this one)
                    const dates = Object.keys(streakData.history)
                        .filter(d => d < dateISO && streakData.history[d] >= state.goals.daily) // Filter valid past days
                        .sort((a, b) => new Date(b) - new Date(a)); // Sort descending
                    streakData.lastValidDate = dates.length > 0 ? dates[0] : null;
                    if (!streakData.lastValidDate) streakData.current = 0; // Safety, if no valid past date found
                }
            }
            // Remove the day from history regardless
            delete streakData.history[dateISO];
        }


        function saveStreakData(data) {
            localStorage.setItem('streak', JSON.stringify(data));
        }

        function updateStreakUI() {
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };
            setText('current-streak-value', `${state.currentStreak.days} dias`);
            const streakFillEl = document.getElementById('streak-progress-fill');
            if (streakFillEl) {
                const streakProgressPercent = state.goals.streak > 0 ? Math.min((state.currentStreak.days / state.goals.streak) * 100, 100) : 0;
                streakFillEl.style.width = `${streakProgressPercent}%`;
            }
        }

        function openGoalsModal() {
            const modal = document.getElementById('goals-modal');
            const overlay = document.getElementById('goals-modal-overlay');
            if (modal && overlay) {
                // Populate modal with current goals from state
                document.getElementById('daily-goal-input').value = state.goals.daily;
                document.getElementById('weekly-goal-input').value = state.goals.weekly;
                document.getElementById('monthly-goal-input').value = state.goals.monthly;
                document.getElementById('yearly-goal-input').value = state.goals.yearly;
                document.getElementById('streak-goal-input').value = state.goals.streak;

                overlay.classList.add('show');
                modal.classList.add('show');
                document.body.classList.add('modal-open'); // Prevent body scroll
            }
        }

        function closeGoalsModal() {
            const modal = document.getElementById('goals-modal');
            const overlay = document.getElementById('goals-modal-overlay');
            if (modal && overlay) {
                modal.classList.remove('show');
                overlay.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        function saveGoals() {
            const daily = parseInt(document.getElementById('daily-goal-input').value);
            const weekly = parseInt(document.getElementById('weekly-goal-input').value);
            const monthly = parseInt(document.getElementById('monthly-goal-input').value);
            const yearly = parseInt(document.getElementById('yearly-goal-input').value);
            const streak = parseInt(document.getElementById('streak-goal-input').value);

            // Basic validation
            if (isNaN(daily) || daily < 1 || isNaN(weekly) || weekly < 1 ||
                isNaN(monthly) || monthly < 1 || isNaN(yearly) || yearly < 1 ||
                isNaN(streak) || streak < 1) {
                alert("Todas as metas devem ser números positivos.");
                return;
            }

            state.goals.daily = daily;
            state.goals.weekly = weekly;
            state.goals.monthly = monthly;
            state.goals.yearly = yearly;
            state.goals.streak = streak;

            saveState();
            updateUI(); // Refresh UI with new goals
            updateStreak(); // Recalculate streak as daily goal might have changed
            closeGoalsModal();
        }

        function toggleTheme() {
            state.isDarkMode = !state.isDarkMode;
            applyTheme();
            saveState(); // Save theme preference
        }

        function applyTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');
            const faviconEl = document.getElementById('favicon');
            const docElement = document.documentElement;

            // Clear potential old theme class from root for inline script compatibility
            docElement.classList.remove('light-theme-active');
            // Set CSS variable for body background (used by particles)
            const bodyBgVar = state.isDarkMode ? '#020306' : '#f8f9fa';
            docElement.style.setProperty('--body-bg', bodyBgVar);


            if (state.isDarkMode) {
                body.classList.remove('light');
                if (themeIcon) {
                    themeIcon.classList.remove('bi-sun-fill');
                    themeIcon.classList.add('bi-moon-fill');
                }
            } else {
                body.classList.add('light');
                docElement.classList.add('light-theme-active'); // Add to root for loader case
                if (themeIcon) {
                    themeIcon.classList.remove('bi-moon-fill');
                    themeIcon.classList.add('bi-sun-fill');
                }
            }

            // Update favicon color based on current primary color
            const primaryColorValue = getComputedStyle(docElement).getPropertyValue('--primary-color-dark').trim(); // Always use dark for consistency or pick based on theme
            if (faviconEl) {
                faviconEl.href = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='${encodeURIComponent(primaryColorValue)}' class='bi bi-check2-square' viewBox='0 0 16 16'><path d='M3 14.5A1.5 1.5 0 0 1 1.5 13V3A1.5 1.5 0 0 1 3 1.5h8A1.5 1.5 0 0 1 12.5 3v1.5a.5.5 0 0 1-1 0V3a.5.5 0 0 0-.5-.5H3a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 1 0 1H3z'/><path d='m8.354 10.354 7-7a.5.5 0 0 0-.708-.708L8 9.293 5.354 6.646a.5.5 0 1 0-.708.708l3 3a.5.5 0 0 0 .708 0z'/></svg>`;
            }

            // Re-render chart with new theme colors (important for grids, ticks, etc.)
            setupChart(false); // No animation for theme change
        }

        function setupChart(animateInitialRender = false) {
            const chartCanvas = document.getElementById('weeklyActivityChart');
            if (!chartCanvas) return;
            const ctx = chartCanvas.getContext('2d');

            // Destroy existing chart instance if it exists
            if (weeklyChartInstance) {
                weeklyChartInstance.destroy();
                weeklyChartInstance = null;
            }

            const data = state.weeklyActivityData;
            // Validate data before trying to render chart
            if (!Array.isArray(data) || data.length !== 7) {
                // Optional: Display an error message on the canvas
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillStyle = state.isDarkMode ? '#AAA' : '#495057';
                ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, sans-serif';
                ctx.fillText("Dados de atividade inválidos.", chartCanvas.width / 2, chartCanvas.height / 2);
                return;
            }


            // Get theme-dependent colors
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue(state.isDarkMode ? '--primary-color-dark' : '--primary-color-light').trim();
            const gridColor = state.isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const textColor = state.isDarkMode ? '#AAA' : '#495057';
            const tooltipBackgroundColor = state.isDarkMode ? 'rgba(30, 30, 30, 0.85)' : 'rgba(250, 250, 250, 0.9)';
            const tooltipTextColor = state.isDarkMode ? '#FFFFFF' : '#212121';
            const bodyBgColor = getComputedStyle(document.body).backgroundColor; // For point border

            // Gradient fill for the area under the line
            const gradient = ctx.createLinearGradient(0, 0, 0, chartCanvas.height * 0.8); // Adjust gradient spread
            gradient.addColorStop(0, Chart.helpers.color(primaryColor).alpha(0.3).rgbString()); // Start color
            gradient.addColorStop(1, Chart.helpers.color(primaryColor).alpha(0).rgbString());   // End color (transparent)

            const dayLabels = getLast7DayLabels();

            weeklyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: [{
                        label: 'Questões',
                        data: [...data], // Use a copy of the data
                        borderColor: primaryColor,
                        backgroundColor: gradient, // Gradient fill
                        fill: true,
                        tension: 0.4, // Smoothens the line
                        pointBackgroundColor: primaryColor,
                        pointBorderColor: bodyBgColor, // Contrast with point color
                        pointBorderWidth: 1.5,
                        pointHoverBackgroundColor: primaryColor,
                        pointHoverBorderColor: bodyBgColor,
                        pointHoverBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: animateInitialRender ? 800 : 0, // Animate only on initial load
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor, drawBorder: false, },
                            ticks: { color: textColor, precision: 0, maxTicksLimit: 5, }
                        },
                        x: {
                            grid: { display: false, }, // No vertical grid lines
                            ticks: { color: textColor, }
                        }
                    },
                    plugins: {
                        legend: { display: false }, // No legend needed for single dataset
                        tooltip: {
                            enabled: true, backgroundColor: tooltipBackgroundColor, titleColor: tooltipTextColor,
                            bodyColor: tooltipTextColor, titleFont: { weight: 'bold', size: 13 },
                            bodyFont: { size: 12 }, padding: 10, cornerRadius: 6,
                            borderColor: primaryColor, borderWidth: 1, displayColors: false,
                            callbacks: {
                                title: (tooltipItems) => tooltipItems[0].label, // Day name as title
                                label: (tooltipItem) => `Questões: ${tooltipItem.raw}` // Value
                            }
                        }
                    },
                    interaction: { mode: 'index', intersect: false, }, // Tooltip on hover near points
                    hover: { mode: 'nearest', intersect: true }
                }
            });
        }

        // Function to update only chart data without full re-render, useful for frequent updates
        function updateWeeklyChartDataOnly() {
            if (weeklyChartInstance && Array.isArray(state.weeklyActivityData) && state.weeklyActivityData.length === 7) {
                weeklyChartInstance.data.datasets[0].data = [...state.weeklyActivityData]; // Update data
                weeklyChartInstance.update(); // Chart.js handles efficient update
            } else if (!weeklyChartInstance) {
                // If chart wasn't initialized for some reason, try setting it up.
                setupChart(false);
            }
        }


        function initStreak() {
            const savedData = localStorage.getItem('streak');
            if (savedData) {
                try {
                    const streakData = JSON.parse(savedData);
                    // Validate loaded streak data structure
                    if (streakData && typeof streakData.current !== 'undefined') {
                        state.currentStreak.days = streakData.current;
                        state.currentStreak.lastCompletionDate = streakData.lastValidDate || null;
                        // history can be large, maybe don't load it into main state unless needed
                    } else {
                        // Malformed data, reset to initial default's streak
                        state.currentStreak = { ...initialDefaultState.currentStreak };
                    }
                } catch (e) {
                    console.error("Error parsing streak data:", e);
                    state.currentStreak = { ...initialDefaultState.currentStreak }; // Fallback
                }
            } else {
                // No saved streak, use initial default state for streak
                // and save it to localStorage for the first time
                state.currentStreak = { ...initialDefaultState.currentStreak };
                const initialStreakDataToSave = {
                    current: state.currentStreak.days,
                    lastValidDate: state.currentStreak.lastCompletionDate,
                    history: {} // Initialize empty history
                };
                // If initial streak is > 0, populate history hypothetically
                if (state.currentStreak.days > 0 && state.currentStreak.lastCompletionDate) {
                    for (let i = 0; i < state.currentStreak.days; i++) {
                        const date = new Date(state.currentStreak.lastCompletionDate);
                        date.setDate(date.getDate() - i);
                        initialStreakDataToSave.history[date.toISOString().split('T')[0]] = state.goals.daily; // Assume goal was met
                    }
                }
                localStorage.setItem('streak', JSON.stringify(initialStreakDataToSave));
            }
            updateStreak(); // Process current day against loaded/initialized streak
            updateStreakUI(); // Display it
        }

        function applyPrimaryColor(color) {
            document.documentElement.style.setProperty('--primary-color-light', color);
            document.documentElement.style.setProperty('--primary-color-dark', color);
            localStorage.setItem('taskify-primary-color', color);
            applyTheme(); // Re-apply theme to update dependent colors (chart, favicon)
        }
        function initColorPicker() {
            const logoElement = document.querySelector('.logo');
            const directColorInput = document.getElementById('direct-color-input');

            if (!logoElement) {
                console.warn("Elemento .logo não encontrado para o seletor de cores!");
                return;
            }
            if (!directColorInput) {
                console.warn("Elemento #direct-color-input não encontrado!");
                return;
            }


            logoElement.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevent other clicks if logo is inside something else

                // Simple click animation for feedback
                logoElement.style.transform = 'scale(0.92)';
                setTimeout(() => {
                    logoElement.style.transform = 'scale(1)';
                }, 150);

                // Get current primary color to pre-fill the color picker
                let currentPrimaryColor = localStorage.getItem('taskify-primary-color') ||
                    getComputedStyle(document.documentElement).getPropertyValue(state.isDarkMode ? '--primary-color-dark' : '--primary-color-light').trim() ||
                    '#007AFF'; // Fallback
                directColorInput.value = currentPrimaryColor;
                directColorInput.click(); // Programmatically open the native color picker
            });

            // Update color live while dragging (input event)
            directColorInput.addEventListener('input', (event) => {
                applyPrimaryColor(event.target.value);
            });
            // Final color selection (change event)
            directColorInput.addEventListener('change', (event) => {
                applyPrimaryColor(event.target.value);
            });
        }


        function init() {
            const loaderElement = document.getElementById('loader');
            if (loaderElement) loaderElement.style.display = 'flex'; // Show loader

            loadState();        // Load data from localStorage
            initColorPicker();  // Setup color picker functionality
            applyTheme();       // Apply loaded or default theme and color

            checkAllResets();   // Check if daily/weekly etc. counters need reset
            initStreak();       // Initialize or load streak data

            setupChart(true);   // Setup chart with initial animation
            updateUI();         // Populate UI with all data

            // Event listener for goals form submission
            const goalsForm = document.getElementById('goals-form');
            if (goalsForm) {
                goalsForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    saveGoals();
                });
            }
            // Event listener for modal overlay click to close modal
            const goalsOverlay = document.getElementById('goals-modal-overlay');
            if (goalsOverlay) {
                goalsOverlay.addEventListener('click', closeGoalsModal);
            }

            // Periodically check for date changes (e.g., if app is left open past midnight)
            setInterval(checkAllResets, 60000); // Check every minute

            // Hide loader after a short delay to ensure everything is rendered
            setTimeout(() => {
                if (loaderElement) {
                    loaderElement.style.opacity = '0';
                    setTimeout(() => {
                        loaderElement.style.display = 'none';
                    }, 500); // Wait for opacity transition
                }
            }, 250); // Adjust delay as needed
        }

        // Start the application once the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', init);

        // Particle animation script (remains largely the same)
        const particleCanvas = document.getElementById('particle-canvas');
        if (particleCanvas) {
            const ctx = particleCanvas.getContext('2d');
            let particlesArray = [];
            let lastParticleTime = 0;
            const particleCooldown = 30; // ms between particle bursts
            let currentMouseX = -1000; // Off-screen initially
            let currentMouseY = -1000;

            function resizeCanvas() {
                particleCanvas.width = window.innerWidth;
                particleCanvas.height = window.innerHeight;
            }

            function setupParticleListeners() {
                window.addEventListener('resize', resizeCanvas);
                document.addEventListener('mousemove', (event) => {
                    currentMouseX = event.clientX;
                    currentMouseY = event.clientY;
                });
                document.addEventListener('touchmove', (event) => {
                    if (event.touches.length > 0) {
                        currentMouseX = event.touches[0].clientX;
                        currentMouseY = event.touches[0].clientY;
                    }
                });
                // Stop particles if mouse leaves or touch ends
                document.addEventListener('mouseleave', () => { currentMouseX = -1000; });
                document.addEventListener('touchend', () => { currentMouseX = -1000; });
                resizeCanvas(); // Initial size
            }


            class Particle {
                constructor(x, y, color) {
                    this.x = x;
                    this.y = y;
                    this.size = Math.random() * 4 + 1.5; // Random size
                    this.baseSize = this.size;
                    this.color = color;
                    this.speedX = Math.random() * 2 - 1; // Random horizontal speed
                    this.speedY = Math.random() * 2 - 1; // Random vertical speed
                    this.life = Math.random() * 60 + 30; // Lifespan in frames
                    this.initialLife = this.life;
                }

                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    this.life--;
                    if (this.life > 0) {
                        // Shrink particle as it ages
                        this.size = this.baseSize * (this.life / this.initialLife);
                    }
                    if (this.size < 0.1) this.size = 0; // Effectively dead
                }

                draw() {
                    if (this.size > 0) {
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }

            function handleParticles(timestamp) {
                // Create new particles if mouse is on screen and cooldown passed
                if (currentMouseX > -1000 && timestamp - lastParticleTime > particleCooldown) {
                    let primaryColor = '#007AFF'; // Default
                    // Safely get primary color, considering state might not be fully init early on
                    if (typeof state !== 'undefined' && state.isDarkMode !== undefined) {
                        primaryColor = getComputedStyle(document.documentElement)
                            .getPropertyValue(state.isDarkMode ? '--primary-color-dark' : '--primary-color-light').trim();
                    } else { // Fallback if state isn't ready (e.g. very early script execution)
                        const tempPrimaryColor = localStorage.getItem('taskify-primary-color');
                        if (tempPrimaryColor) {
                            primaryColor = tempPrimaryColor;
                        } else {
                            const theme = localStorage.getItem('taskify-theme');
                            primaryColor = (theme === 'light') ?
                                getComputedStyle(document.documentElement).getPropertyValue('--primary-color-light').trim() || '#007AFF' :
                                getComputedStyle(document.documentElement).getPropertyValue('--primary-color-dark').trim() || '#007AFF';
                        }
                    }

                    for (let i = 0; i < 1; i++) { // Number of particles per burst
                        const offsetX = (Math.random() - 0.5) * 10; // Slight spread
                        const offsetY = (Math.random() - 0.5) * 10;
                        particlesArray.push(new Particle(currentMouseX + offsetX, currentMouseY + offsetY, primaryColor));
                    }
                    lastParticleTime = timestamp;
                }

                // Update and remove dead particles
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].update();
                    if (particlesArray[i].life <= 0 ||
                        particlesArray[i].x < -20 || particlesArray[i].x > particleCanvas.width + 20 || // Off-screen check
                        particlesArray[i].y < -20 || particlesArray[i].y > particleCanvas.height + 20) {
                        particlesArray.splice(i, 1);
                        i--; // Adjust index after removal
                    }
                }
            }

            function animateParticles(timestamp) {
                ctx.clearRect(0, 0, particleCanvas.width, particleCanvas.height); // Clear canvas
                handleParticles(timestamp); // Update particle logic
                for (let i = 0; i < particlesArray.length; i++) {
                    particlesArray[i].draw(); // Draw all active particles
                }
                requestAnimationFrame(animateParticles); // Loop
            }

            // Defer particle setup until DOM is ready to avoid issues with canvas element
            if (document.readyState === 'complete' || (document.readyState !== 'loading' && !document.documentElement.doScroll)) {
                setupParticleListeners();
                requestAnimationFrame(animateParticles);
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    setupParticleListeners();
                    requestAnimationFrame(animateParticles);
                });
            }

        } else {
            console.warn("Elemento #particle-canvas não encontrado.");
        }
    </script>

</body>

</html>